const Patient = require('../models/patientModel.js');
const User = require('../models/userModel.js');

async function tambahPatient(req, res) {
  const { nama, umur, jenisPenyakit, catatan, kode, alamatRumah, alamatTujuan } = req.body;
  if (!nama || !umur || !jenisPenyakit || !catatan || !kode || !alamatRumah || !alamatTujuan) {
    return res.status(400).json({
      status: 400,
      success: false,
      error: 'Each column must be filled in'
    });
  }
  let alamatRumahObj = JSON.parse(alamatRumah);
  console.log('Parsed alamatRumah:', alamatRumahObj);

  let alamatTujuanObj = JSON.parse(alamatTujuan);
  console.log('Parsed alamatTujuan:', alamatTujuanObj);

  try {
    const existingKode = await Patient.findOne({ kode });
    if (existingKode) {
      return res.status(400).json({
        status: 400,
        success: false,
        error: 'Kode already used in another device'
      });
    }
    const user = await User.findById(req.user.userId);
    if (user.patients.length >= 1) {
      return res.status(400).json({
        status: 400,
        success: false,
        error: 'You already have a patient. Cannot add more than one patient.'
      });
    }
    const dataPatient = await Patient.create({
      nama,
      umur,
      jenisPenyakit,
      catatan,
      kode,
      alamatRumah : alamatRumahObj,
      alamatTujuan : alamatTujuanObj,
      createdBy: req.user.userId
    });
    // const user = await User.findByIdAndUpdate(
    //   req.user.userId,
    //   { $push: { patients: dataPatient._id } },
    //   { new: true }
    // );
    const updatedUser = await User.findByIdAndUpdate(
      req.user.userId,
      { $set: { patients: [dataPatient._id] } },
      { new: true }
    );


    res.status(200).json({
      status: 200,
      success: true,
      message: 'Patient data saved successfully', 
      data: dataPatient,
      user : {nama: updatedUser.nama, email: updatedUser.email}
    });
  } catch (error) {
    console.log(error)
    return res.status(500).json({
      status: 500,
      success: false,
      error: "An error occurred while saving patient data"
    });
  }
}

async function getPatient(req, res) {
  const { id } = req.params; 

  try {
    const dataPatient = await Patient.findById(id);

    if (!dataPatient) {
      return res.status(404).json({
        status: 404,
        success: false,
        error: 'Patient data not found'
      });
    }
    if (dataPatient.createdBy.toString() !== req.user.userId) {
      return res.status(403).json({
        status: 403,
        success: false,
        error: 'You do not have permission to access this patient data'
      });
    }
    res.status(200).json({
      status: 200,
      success: true,
      message: 'Successfully get data patient',
      data: dataPatient
    });
  } catch (error) {
    res.status(500).json({
      status: 500,
      success: false,
      error: 'An error occurred while retrieving patient data'
    });
  }
}

async function updatePatient(req, res){
  const { id } = req.params;
  const { nama, umur, jenisPenyakit, catatan, kode} = req.body;
  let { alamatRumah, alamatTujuan } = req.body;
  try {
    const existingPatient = await Patient.findById(id);
    if (!existingPatient) {
      return res.status(404).json({
        status: 404,
        success: false,
        error: 'Patient data not found'
      });
    }

    if (existingPatient.createdBy.toString() !== req.user.userId) {
      return res.status(403).json({
        status: 403,
        success: false,
        error: 'You do not have permission to update this patient data'
      });
    }
    console.log('Updating patient data:', { id, nama, umur, jenisPenyakit, catatan, kode, alamatRumah, alamatTujuan });
    if (typeof alamatRumah === 'string') {
      alamatRumah = JSON.parse(alamatRumah);
    }
    if (typeof alamatTujuan === 'string') {
      alamatTujuan = JSON.parse(alamatTujuan);
    }
    const updatedPatient = await Patient.findByIdAndUpdate(id, {
      nama,
      umur,
      jenisPenyakit,
      catatan,
      kode,
      alamatRumah,
      alamatTujuan,
    }, { new: true });

    if (!updatedPatient) {
      return res.status(404).json({
        status: 404,
        success: false,
        error: 'Patient data not found'
      });
    }

    res.json({
      status: 200,
      success: true,
      message: 'Patient data is updated successfully',
      data: updatedPatient
    });
  } catch (error) {
    res.status(500).json({
      status: 500,
      success: false,
      error: 'An error occurred while updating patient data'
    });
  }
}

async function getPatientByKode(kode) {
  return await Patient.findOne({ kode: kode });
}

module.exports = {
  tambahPatient,
  getPatient,
  updatePatient,
  getPatientByKode
};